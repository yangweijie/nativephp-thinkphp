<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>键盘监听器</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>键盘监听器</h1>
            <div class="nav">
                <a href="/keyboard/index">主页</a>
                <a href="/keyboard/history">历史记录</a>
                <a href="/keyboard/listener" class="active">键盘监听器</a>
            </div>
        </div>
        
        <div class="content">
            <div class="card">
                <div class="card-header">
                    <h2>键盘事件监听</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="event">事件类型</label>
                        <select id="event" class="form-control">
                            <option value="keydown">keydown（按下按键时触发）</option>
                            <option value="keyup">keyup（松开按键时触发）</option>
                            <option value="keypress">keypress（按下并松开按键时触发）</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="startButton" class="btn btn-primary" onclick="startListener()">开始监听</button>
                        <button id="stopButton" class="btn btn-danger" onclick="stopListener()" style="display: none;">停止监听</button>
                    </div>
                    
                    <div id="listenerStatus" class="alert alert-info" style="display: none;"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>键盘事件记录</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="refreshEvents()">刷新</button>
                        <button class="btn btn-danger" onclick="clearEvents()">清空记录</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="eventsContainer">
                        <p>暂无事件记录</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>按键测试区域</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="testInput">在此处按键进行测试</label>
                        <input type="text" id="testInput" class="form-control" placeholder="点击此处并按下任意键">
                    </div>
                    
                    <div id="testResult" class="alert alert-info" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // 页面加载完成后检查监听器状态
        document.addEventListener('DOMContentLoaded', function() {
            checkListenerStatus();
            loadEvents();
        });
        
        // 检查监听器状态
        function checkListenerStatus() {
            // 这里应该从服务器获取监听器状态
            // 为了简化示例，我们假设没有正在运行的监听器
            updateListenerStatus(false);
        }
        
        // 更新监听器状态显示
        function updateListenerStatus(isRunning, event = '') {
            const statusElement = document.getElementById('listenerStatus');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            
            if (isRunning) {
                statusElement.textContent = `正在监听 ${event} 事件...`;
                statusElement.style.display = 'block';
                startButton.style.display = 'none';
                stopButton.style.display = 'inline-block';
            } else {
                statusElement.textContent = '监听器未运行';
                statusElement.style.display = 'block';
                startButton.style.display = 'inline-block';
                stopButton.style.display = 'none';
            }
        }
        
        // 开始监听
        function startListener() {
            const event = document.getElementById('event').value;
            
            fetch('/keyboard/startListener', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    event,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    updateListenerStatus(true, event);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '启动监听器失败');
            });
        }
        
        // 停止监听
        function stopListener() {
            fetch('/keyboard/stopListener', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    updateListenerStatus(false);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '停止监听器失败');
            });
        }
        
        // 加载事件记录
        function loadEvents() {
            fetch('/keyboard/getKeyEvents')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayEvents(data.events);
                } else {
                    showNotification('错误', '获取事件记录失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '获取事件记录失败');
            });
        }
        
        // 显示事件记录
        function displayEvents(events) {
            const container = document.getElementById('eventsContainer');
            
            if (events.length === 0) {
                container.innerHTML = '<p>暂无事件记录</p>';
                return;
            }
            
            let html = '<table class="table">';
            html += '<thead><tr><th>时间</th><th>事件类型</th><th>按键</th><th>修饰键</th><th>键码</th></tr></thead>';
            html += '<tbody>';
            
            events.forEach(event => {
                html += '<tr>';
                html += `<td>${event.time}</td>`;
                html += `<td>${event.type}</td>`;
                html += `<td>${event.key || ''}</td>`;
                html += `<td>${formatModifiers(event.modifiers || [])}</td>`;
                html += `<td>${event.keyCode || ''}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // 格式化修饰键
        function formatModifiers(modifiers) {
            if (!modifiers || modifiers.length === 0) {
                return '无';
            }
            
            return modifiers.join(', ');
        }
        
        // 刷新事件记录
        function refreshEvents() {
            loadEvents();
        }
        
        // 清空事件记录
        function clearEvents() {
            if (!confirm('确定要清空事件记录吗？此操作不可恢复。')) {
                return;
            }
            
            fetch('/keyboard/clearKeyEvents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    loadEvents();
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '清空事件记录失败');
            });
        }
        
        // 按键测试
        document.getElementById('testInput').addEventListener('keydown', function(e) {
            const result = document.getElementById('testResult');
            result.textContent = `按键: ${e.key}, 键码: ${e.keyCode}, 修饰键: ${getModifiers(e)}`;
            result.style.display = 'block';
        });
        
        // 获取修饰键
        function getModifiers(event) {
            const modifiers = [];
            
            if (event.shiftKey) {
                modifiers.push('Shift');
            }
            
            if (event.ctrlKey) {
                modifiers.push('Control');
            }
            
            if (event.altKey) {
                modifiers.push('Alt');
            }
            
            if (event.metaKey) {
                modifiers.push('Meta');
            }
            
            return modifiers.length > 0 ? modifiers.join(', ') : '无';
        }
        
        // 显示通知
        function showNotification(title, body) {
            if (typeof window.NativePHP !== 'undefined') {
                window.NativePHP.notification.send(title, body);
            } else {
                alert(`${title}: ${body}`);
            }
        }
    </script>
</body>
</html>
