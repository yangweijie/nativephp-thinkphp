<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>网络状态</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        h2 {
            color: #555;
            margin-top: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .info-item {
            margin-bottom: 10px;
        }
        .info-label {
            font-weight: bold;
            display: inline-block;
            width: 150px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online {
            background-color: #4CAF50;
        }
        .status-offline {
            background-color: #f44336;
        }
        .status-unknown {
            background-color: #9e9e9e;
        }
        .network-interfaces {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .interface-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .interface-item:last-child {
            border-bottom: none;
        }
        .interface-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .interface-address {
            margin-left: 10px;
            font-family: monospace;
        }
        .progress-bar {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>网络状态</h1>
        
        <div class="section">
            <h2>网络状态信息</h2>
            <div class="button-group">
                <button onclick="refreshNetworkStatus()">刷新状态</button>
            </div>
            <div class="result">
                <div class="info-item">
                    <span class="info-label">网络状态：</span>
                    <span id="networkStatus">
                        <span class="status-indicator status-{$status.isOnline ? 'online' : 'offline'}"></span>
                        {$status.status}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">IP 地址：</span>
                    <span id="ipAddress">{$status.ipAddress}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">MAC 地址：</span>
                    <span id="macAddress">{$status.macAddress}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">连接类型：</span>
                    <span id="connectionType">{$status.connectionType}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">下载速度：</span>
                    <span id="downloadSpeed">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">上传速度：</span>
                    <span id="uploadSpeed">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">公网 IP：</span>
                    <span id="publicIP">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">DNS 服务器：</span>
                    <span id="dnsServers">-</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>网络接口</h2>
            <div id="networkInterfaces" class="network-interfaces">
                {volist name="status.interfaces" id="interface" key="interfaceName"}
                <div class="interface-item">
                    <div class="interface-name">{$interfaceName}</div>
                    {volist name="interface" id="address"}
                    <div class="interface-address">
                        {$address.family}: {$address.address}
                        {if isset($address.mac) && $address.mac}
                        (MAC: {$address.mac})
                        {/if}
                        {if isset($address.internal) && $address.internal}
                        (内部)
                        {/if}
                    </div>
                    {/volist}
                </div>
                {/volist}
            </div>
        </div>
        
        <div class="section">
            <h2>网络测试</h2>
            <div class="form-group">
                <label for="testHost">主机名或 IP 地址</label>
                <input type="text" id="testHost" placeholder="例如：www.example.com 或 8.8.8.8" value="www.baidu.com">
            </div>
            <div class="form-group">
                <label for="testPort">端口</label>
                <input type="number" id="testPort" placeholder="例如：80" value="80">
            </div>
            <div class="form-group">
                <label for="testTimeout">超时（毫秒）</label>
                <input type="number" id="testTimeout" placeholder="例如：5000" value="5000">
            </div>
            <div class="button-group">
                <button onclick="testConnection()">测试连接</button>
            </div>
            <div class="result" id="testResult" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>域名解析</h2>
            <div class="form-group">
                <label for="domainName">域名</label>
                <input type="text" id="domainName" placeholder="例如：www.example.com" value="www.baidu.com">
            </div>
            <div class="button-group">
                <button onclick="resolveDomain()">解析域名</button>
            </div>
            <div class="result" id="resolveResult" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>网络使用情况</h2>
            <div class="info-item">
                <span class="info-label">已接收数据：</span>
                <span id="receivedData">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">已发送数据：</span>
                <span id="sentData">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">带宽：</span>
                <span id="bandwidth">-</span>
            </div>
        </div>
    </div>
    
    <script>
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 刷新网络状态
            refreshNetworkStatus();
            
            // 设置定时刷新
            setInterval(refreshNetworkStatus, 5000);
        });
        
        // 刷新网络状态
        function refreshNetworkStatus() {
            fetch('/system-tools/getNetworkStatus', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateNetworkStatus(data.status);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // 更新网络状态
        function updateNetworkStatus(status) {
            // 更新状态指示器
            const statusIndicator = document.querySelector('#networkStatus .status-indicator');
            statusIndicator.className = 'status-indicator status-' + (status.isOnline ? 'online' : 'offline');
            
            // 更新状态文本
            document.querySelector('#networkStatus').innerHTML = `
                <span class="status-indicator status-${status.isOnline ? 'online' : 'offline'}"></span>
                ${status.status}
            `;
            
            // 更新其他信息
            document.getElementById('ipAddress').textContent = status.ipAddress || '-';
            document.getElementById('macAddress').textContent = status.macAddress || '-';
            document.getElementById('connectionType').textContent = status.connectionType || '-';
            document.getElementById('downloadSpeed').textContent = formatBytes(status.downloadSpeed) + '/s';
            document.getElementById('uploadSpeed').textContent = formatBytes(status.uploadSpeed) + '/s';
            document.getElementById('publicIP').textContent = status.publicIP || '-';
            document.getElementById('dnsServers').textContent = status.dnsServers ? status.dnsServers.join(', ') : '-';
            
            // 更新网络使用情况
            if (status.usage) {
                document.getElementById('receivedData').textContent = formatBytes(status.usage.received);
                document.getElementById('sentData').textContent = formatBytes(status.usage.sent);
            }
            
            // 更新带宽
            if (status.bandwidth) {
                document.getElementById('bandwidth').textContent = `下载: ${formatBytes(status.bandwidth.download)}/s, 上传: ${formatBytes(status.bandwidth.upload)}/s`;
            }
        }
        
        // 测试网络连接
        function testConnection() {
            const host = document.getElementById('testHost').value;
            const port = document.getElementById('testPort').value;
            const timeout = document.getElementById('testTimeout').value;
            
            if (!host) {
                alert('主机名或 IP 地址不能为空');
                return;
            }
            
            const testResult = document.getElementById('testResult');
            testResult.style.display = 'block';
            testResult.innerHTML = '测试中...';
            
            fetch('/system-tools/testConnection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    host: host,
                    port: port,
                    timeout: timeout,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    testResult.innerHTML = `
                        <div style="color: ${data.result ? '#4CAF50' : '#f44336'}">
                            连接测试: ${data.result ? '成功' : '失败'}
                        </div>
                        <div>
                            Ping: ${data.ping} ms
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `<div style="color: #f44336">测试失败: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                testResult.innerHTML = `<div style="color: #f44336">测试失败: ${error.message}</div>`;
            });
        }
        
        // 解析域名
        function resolveDomain() {
            const domain = document.getElementById('domainName').value;
            
            if (!domain) {
                alert('域名不能为空');
                return;
            }
            
            const resolveResult = document.getElementById('resolveResult');
            resolveResult.style.display = 'block';
            resolveResult.innerHTML = '解析中...';
            
            fetch('/system-tools/resolveDomain', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    domain: domain,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.addresses.length > 0) {
                        let html = '<ul>';
                        data.addresses.forEach(address => {
                            html += `<li>${address}</li>`;
                        });
                        html += '</ul>';
                        resolveResult.innerHTML = html;
                    } else {
                        resolveResult.innerHTML = '未找到 IP 地址';
                    }
                } else {
                    resolveResult.innerHTML = `<div style="color: #f44336">解析失败: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resolveResult.innerHTML = `<div style="color: #f44336">解析失败: ${error.message}</div>`;
            });
        }
        
        // 格式化字节数
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0 || bytes === undefined || bytes === null) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
