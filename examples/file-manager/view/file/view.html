<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>查看文件 - {$filename}</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <!-- 添加代码高亮样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <!-- 添加常用语言支持 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/markdown.min.js"></script>
    <style>
        .code-preview {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        .code-language {
            font-weight: bold;
            color: #555;
        }

        .code-actions {
            display: flex;
            gap: 10px;
        }

        .code-actions button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .code-content {
            padding: 15px;
            overflow: auto;
            max-height: 600px;
            background-color: #fff;
        }

        .code-content pre {
            margin: 0;
            padding: 0;
        }

        .code-content code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            padding: 15px 10px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            text-align: right;
            color: #999;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.5;
            user-select: none;
        }

        /* 图片预览增强 */
        .image-preview {
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 600px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .image-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
            text-align: left;
        }

        .image-info table {
            width: 100%;
            border-collapse: collapse;
        }

        .image-info th, .image-info td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .image-info th {
            width: 150px;
            text-align: right;
            font-weight: 600;
            color: #555;
        }

        /* PDF预览增强 */
        .pdf-preview {
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        /* 音频预览增强 */
        .audio-preview {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            text-align: center;
        }

        .audio-preview audio {
            width: 100%;
            max-width: 500px;
        }

        /* 视频预览增强 */
        .video-preview {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            text-align: center;
        }

        .video-preview video {
            max-width: 100%;
            max-height: 600px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>查看文件: {$filename}</h1>
            <div class="path-navigation">
                <input type="text" id="pathInput" value="{$path}" readonly>
            </div>
            <div class="actions">
                <a href="/file/index?path={:urlencode(dirname($path))}" class="btn">返回</a>
                <a href="/file/edit?path={:urlencode($path)}" class="btn btn-primary">编辑</a>
                <button onclick="openFile('{$path}')" class="btn">使用系统应用打开</button>
                <button onclick="showInFolder('{$path}')" class="btn">在文件夹中显示</button>
                <button onclick="copyToClipboard()" class="btn">复制内容</button>
                <button onclick="downloadFile('{$path}', '{$filename}')" class="btn">下载</button>
                <a href="/version/index?path={:urlencode($path)}" class="btn" id="versionHistoryBtn">版本历史</a>
                <button onclick="createVersion()" class="btn" id="createVersionBtn" style="display: none;">创建版本</button>
            </div>
        </div>

        <div class="file-content">
            {if isset($isTruncated) && $isTruncated}
                <div class="file-warning">
                    <p>注意：文件过大，只显示前 {$maxSize}。文件实际大小：{$fileSize}。</p>
                    <p>请使用系统默认应用打开此文件以查看完整内容。</p>
                </div>
            {/if}

            {if in_array($extension, ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'])}
                <div class="image-preview">
                    <img src="data:image/{$extension};base64,{:base64_encode($content)}" alt="{$filename}">

                    <div class="image-info">
                        <table>
                            <tr>
                                <th>文件名:</th>
                                <td>{$filename}</td>
                            </tr>
                            <tr>
                                <th>文件大小:</th>
                                <td>{$fileSize}</td>
                            </tr>
                            <tr>
                                <th>文件类型:</th>
                                <td>图片 ({$extension})</td>
                            </tr>
                            {if isset($imageInfo)}
                            <tr>
                                <th>尺寸:</th>
                                <td>{$imageInfo.width} x {$imageInfo.height} 像素</td>
                            </tr>
                            {/if}
                        </table>
                    </div>
                </div>
            {elseif in_array($extension, ['mp4', 'webm', 'ogg'])}
                <div class="video-preview">
                    <video controls>
                        <source src="data:video/{$extension};base64,{:base64_encode($content)}" type="video/{$extension}">
                        您的浏览器不支持视频标签。
                    </video>
                </div>
            {elseif in_array($extension, ['mp3', 'wav', 'ogg'])}
                <div class="audio-preview">
                    <audio controls>
                        <source src="data:audio/{$extension};base64,{:base64_encode($content)}" type="audio/{$extension}">
                        您的浏览器不支持音频标签。
                    </audio>
                </div>
            {elseif in_array($extension, ['pdf'])}
                <div class="pdf-preview">
                    <embed src="data:application/pdf;base64,{:base64_encode($content)}" type="application/pdf" width="100%" height="100%">
                </div>
            {elseif in_array($extension, ['php', 'js', 'css', 'html', 'htm', 'xml', 'json', 'md', 'txt', 'log', 'ini', 'conf', 'yml', 'yaml', 'py', 'java', 'c', 'cpp', 'cs', 'go', 'rb', 'sh', 'bat', 'ps1'])}
                <div class="code-preview">
                    <div class="code-header">
                        <div class="code-language">{$extension}</div>
                        <div class="code-actions">
                            <button onclick="copyCode()">复制代码</button>
                            <button onclick="toggleLineNumbers()">显示/隐藏行号</button>
                        </div>
                    </div>
                    <div class="code-content" id="codeContent">
                        <pre><code class="language-{$extension == 'htm' ? 'html' : $extension}">{:htmlentities($content)}</code></pre>
                    </div>
                </div>
            {else}
                <div class="text-preview">
                    <pre><code>{:htmlentities($content)}</code></pre>
                </div>
            {/if}
        </div>
    </div>

    <!-- 模态框 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">标题</h2>
            <div id="modalBody">内容</div>
            <div id="modalFooter">
                <button id="modalConfirm" class="btn btn-primary">确定</button>
                <button id="modalCancel" class="btn btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化代码高亮
            if (document.querySelector('.language-{$extension}')) {
                hljs.highlightAll();
            }

            // 检查文件是否可以创建版本
            checkVersionSupport();

            // 初始化模态框
            initModal();
        });

        // 复制代码到剪贴板
        function copyCode() {
            const codeElement = document.querySelector('.code-content code');
            if (codeElement) {
                const text = codeElement.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('复制成功', '代码已复制到剪贴板');
                }).catch(err => {
                    showNotification('复制失败', err.message);
                });
            }
        }

        // 复制文件内容到剪贴板
        function copyToClipboard() {
            const content = `{:addslashes($content)}`;
            navigator.clipboard.writeText(content).then(() => {
                showNotification('复制成功', '文件内容已复制到剪贴板');
            }).catch(err => {
                showNotification('复制失败', err.message);
            });
        }

        // 显示/隐藏行号
        function toggleLineNumbers() {
            const codeContent = document.getElementById('codeContent');
            const existingLineNumbers = document.querySelector('.line-numbers');

            if (existingLineNumbers) {
                existingLineNumbers.remove();
                codeContent.style.paddingLeft = '15px';
            } else {
                const code = codeContent.querySelector('code');
                const lineCount = code.innerHTML.split('\n').length;
                const lineNumbers = document.createElement('div');
                lineNumbers.className = 'line-numbers';

                let numbers = '';
                for (let i = 1; i <= lineCount; i++) {
                    numbers += i + '<br>';
                }

                lineNumbers.innerHTML = numbers;
                codeContent.style.paddingLeft = '50px';
                codeContent.appendChild(lineNumbers);
            }
        }

        // 下载文件
        function downloadFile(path, filename) {
            const content = `{:base64_encode($content)}`;
            const link = document.createElement('a');
            link.href = `data:application/octet-stream;base64,${content}`;
            link.download = filename;
            link.click();
        }

        // 显示通知
        function showNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('notification-hide');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 检查文件是否支持版本控制
        function checkVersionSupport() {
            const path = '{$path}';

            fetch('/version/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'path=' + encodeURIComponent(path),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.canCreateVersion) {
                    document.getElementById('createVersionBtn').style.display = 'inline-block';
                }
            })
            .catch(error => {
                console.error('Error checking version support:', error);
            });
        }

        // 创建版本
        function createVersion() {
            showModal('创建版本', `
                <p>为当前文件创建一个版本快照，以便以后可以恢复到这个状态。</p>
                <div class="form-group">
                    <label for="versionComment">版本注释 (可选):</label>
                    <textarea id="versionComment" placeholder="输入版本注释，描述此版本的变更内容"></textarea>
                </div>
            `, function() {
                const comment = document.getElementById('versionComment').value;
                const path = '{$path}';

                fetch('/version/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'path=' + encodeURIComponent(path) + '&comment=' + encodeURIComponent(comment),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('成功', '版本创建成功');
                    } else {
                        showNotification('错误', data.message || '创建版本失败');
                    }
                })
                .catch(error => {
                    showNotification('错误', error.message);
                });
            });
        }
    </script>
</body>
</html>
