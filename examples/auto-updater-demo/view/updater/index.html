<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>自动更新示例</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>自动更新示例</h1>
            <div class="version-info">
                <p><strong>当前版本：</strong> <span id="currentVersion">{$currentVersion}</span></p>
                <p><strong>最新版本：</strong> <span id="latestVersion">未知</span></p>
            </div>
        </div>
        
        <div class="content">
            <div class="card">
                <div class="card-header">
                    <h2>更新配置</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="feedUrl">更新服务器 URL</label>
                        <input type="text" id="feedUrl" class="form-control" value="{$updateConfig.feed_url}" placeholder="https://example.com/updates.json">
                        <div class="help-text">更新服务器 URL 应该返回符合 Electron 自动更新格式的 JSON 数据</div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="autoDownload" {$updateConfig.auto_download ? 'checked' : ''}> 自动下载更新
                            </label>
                            
                            <label>
                                <input type="checkbox" id="autoInstall" {$updateConfig.auto_install ? 'checked' : ''}> 自动安装更新
                            </label>
                            
                            <label>
                                <input type="checkbox" id="allowPrerelease" {$updateConfig.allow_prerelease ? 'checked' : ''}> 允许预发布版本
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>更新操作</h2>
                </div>
                <div class="card-body">
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="checkForUpdates()">检查更新</button>
                        <button class="btn btn-primary" onclick="downloadUpdate()" id="downloadBtn" disabled>下载更新</button>
                        <button class="btn btn-primary" onclick="installUpdate()" id="installBtn" disabled>安装更新</button>
                        <button class="btn btn-danger" onclick="quitAndInstall()" id="quitBtn" disabled>重启并安装</button>
                        <button class="btn btn-secondary" onclick="cancelDownload()" id="cancelBtn" disabled>取消下载</button>
                    </div>
                    
                    <div class="update-progress" id="updateProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
                        </div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>更新信息</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="getUpdateInfo()">刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="updateInfo" class="update-info">
                        <p>暂无更新信息</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>更新日志</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="clearUpdateLog()">清空</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="updateLog" class="update-log">
                        <p>暂无更新日志</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化更新事件监听
            initUpdateEvents();
            
            // 获取更新信息
            getUpdateInfo();
        });
        
        // 初始化更新事件监听
        function initUpdateEvents() {
            if (typeof window.NativePHP !== 'undefined') {
                // 监听更新检查事件
                window.NativePHP.autoUpdater.onCheckingForUpdate(function(event) {
                    addUpdateLog('checking-for-update', '正在检查更新');
                });
                
                // 监听更新可用事件
                window.NativePHP.autoUpdater.onUpdateAvailable(function(event) {
                    const version = event.version || '';
                    addUpdateLog('update-available', `发现新版本: ${version}`);
                    
                    // 更新最新版本
                    document.getElementById('latestVersion').textContent = version;
                    
                    // 启用下载按钮
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('cancelBtn').disabled = false;
                });
                
                // 监听更新不可用事件
                window.NativePHP.autoUpdater.onUpdateNotAvailable(function(event) {
                    const version = event.version || '';
                    addUpdateLog('update-not-available', `当前已是最新版本: ${version}`);
                    
                    // 更新最新版本
                    document.getElementById('latestVersion').textContent = version;
                    
                    // 禁用下载按钮
                    document.getElementById('downloadBtn').disabled = true;
                    document.getElementById('installBtn').disabled = true;
                    document.getElementById('quitBtn').disabled = true;
                    document.getElementById('cancelBtn').disabled = true;
                });
                
                // 监听更新下载进度事件
                window.NativePHP.autoUpdater.onDownloadProgress(function(event) {
                    const percent = event.percent || 0;
                    updateDownloadProgress(percent);
                });
                
                // 监听更新下载完成事件
                window.NativePHP.autoUpdater.onUpdateDownloaded(function(event) {
                    const version = event.version || '';
                    addUpdateLog('update-downloaded', `更新已下载: ${version}`);
                    
                    // 隐藏进度条
                    document.getElementById('updateProgress').style.display = 'none';
                    
                    // 启用安装按钮
                    document.getElementById('installBtn').disabled = false;
                    document.getElementById('quitBtn').disabled = false;
                    
                    // 禁用下载按钮和取消按钮
                    document.getElementById('downloadBtn').disabled = true;
                    document.getElementById('cancelBtn').disabled = true;
                });
                
                // 监听更新错误事件
                window.NativePHP.autoUpdater.onError(function(event) {
                    const error = event.error || '未知错误';
                    addUpdateLog('error', `更新错误: ${error}`);
                    
                    // 隐藏进度条
                    document.getElementById('updateProgress').style.display = 'none';
                    
                    // 禁用按钮
                    document.getElementById('downloadBtn').disabled = true;
                    document.getElementById('installBtn').disabled = true;
                    document.getElementById('quitBtn').disabled = true;
                    document.getElementById('cancelBtn').disabled = true;
                });
            }
        }
        
        // 保存配置
        function saveConfig() {
            const feedUrl = document.getElementById('feedUrl').value;
            const autoDownload = document.getElementById('autoDownload').checked;
            const autoInstall = document.getElementById('autoInstall').checked;
            const allowPrerelease = document.getElementById('allowPrerelease').checked;
            
            if (!feedUrl) {
                showNotification('错误', '更新服务器 URL 不能为空');
                return;
            }
            
            fetch('/updater/setConfig', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    feed_url: feedUrl,
                    auto_download: autoDownload,
                    auto_install: autoInstall,
                    allow_prerelease: allowPrerelease,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '保存配置失败');
            });
        }
        
        // 检查更新
        function checkForUpdates() {
            fetch('/updater/checkForUpdates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '检查更新失败');
            });
        }
        
        // 下载更新
        function downloadUpdate() {
            // 显示进度条
            document.getElementById('updateProgress').style.display = 'block';
            document.getElementById('progressBarFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            
            fetch('/updater/downloadUpdate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                    document.getElementById('updateProgress').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '下载更新失败');
                document.getElementById('updateProgress').style.display = 'none';
            });
        }
        
        // 安装更新
        function installUpdate() {
            fetch('/updater/installUpdate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '安装更新失败');
            });
        }
        
        // 重启应用并安装更新
        function quitAndInstall() {
            if (!confirm('确定要重启应用并安装更新吗？')) {
                return;
            }
            
            fetch('/updater/quitAndInstall', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '重启应用并安装更新失败');
            });
        }
        
        // 取消更新下载
        function cancelDownload() {
            fetch('/updater/cancelDownload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    document.getElementById('updateProgress').style.display = 'none';
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '取消更新下载失败');
            });
        }
        
        // 获取更新信息
        function getUpdateInfo() {
            fetch('/updater/getUpdateInfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新版本信息
                    document.getElementById('currentVersion').textContent = data.currentVersion || '未知';
                    document.getElementById('latestVersion').textContent = data.latestVersion || '未知';
                    
                    // 更新更新信息
                    updateInfoDisplay(data.updateInfo);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '获取更新信息失败');
            });
        }
        
        // 更新下载进度
        function updateDownloadProgress(percent) {
            const progressBar = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';
            
            // 显示进度条
            document.getElementById('updateProgress').style.display = 'block';
        }
        
        // 更新信息显示
        function updateInfoDisplay(info) {
            const updateInfoElement = document.getElementById('updateInfo');
            
            if (!info) {
                updateInfoElement.innerHTML = '<p>暂无更新信息</p>';
                return;
            }
            
            let html = '';
            
            if (info.version) {
                html += `<p><strong>版本：</strong> ${info.version}</p>`;
            }
            
            if (info.releaseDate) {
                html += `<p><strong>发布日期：</strong> ${info.releaseDate}</p>`;
            }
            
            if (info.releaseNotes) {
                html += `<p><strong>发布说明：</strong></p>`;
                html += `<div class="release-notes">${info.releaseNotes}</div>`;
            }
            
            if (html === '') {
                html = '<p>暂无更新信息</p>';
            }
            
            updateInfoElement.innerHTML = html;
        }
        
        // 添加更新日志
        function addUpdateLog(type, message) {
            const updateLogElement = document.getElementById('updateLog');
            const time = new Date().toLocaleString();
            
            // 如果是第一条日志，清空占位符
            if (updateLogElement.innerHTML.includes('暂无更新日志')) {
                updateLogElement.innerHTML = '';
            }
            
            // 创建日志项
            const logItem = document.createElement('div');
            logItem.className = 'log-item ' + type;
            logItem.innerHTML = `
                <div class="log-time">${time}</div>
                <div class="log-message">${message}</div>
            `;
            
            // 添加到日志容器
            updateLogElement.appendChild(logItem);
            
            // 滚动到底部
            updateLogElement.scrollTop = updateLogElement.scrollHeight;
        }
        
        // 清空更新日志
        function clearUpdateLog() {
            document.getElementById('updateLog').innerHTML = '<p>暂无更新日志</p>';
        }
        
        // 显示通知
        function showNotification(title, body) {
            if (typeof window.NativePHP !== 'undefined') {
                window.NativePHP.notification.send(title, body);
            } else {
                alert(`${title}: ${body}`);
            }
        }
    </script>
</body>
</html>
