<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>队列工作进程管理示例</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .row {
            display: flex;
            margin-bottom: 20px;
        }
        .col {
            flex: 1;
            padding: 0 10px;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .panel-header {
            background-color: #f8f8f8;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        .panel-body {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: Consolas, monospace;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkbox-group {
            margin-bottom: 15px;
        }
        .checkbox-group label {
            display: inline;
            font-weight: normal;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #d32f2f;
        }
        button.info {
            background-color: #2196F3;
        }
        button.info:hover {
            background-color: #0b7dda;
        }
        button.warning {
            background-color: #ff9800;
        }
        button.warning:hover {
            background-color: #e68a00;
        }
        .worker-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .worker-item:last-child {
            border-bottom: none;
        }
        .badge {
            display: inline-block;
            padding: 3px 7px;
            border-radius: 10px;
            font-size: 12px;
            color: white;
        }
        .badge-success {
            background-color: #4CAF50;
        }
        .badge-danger {
            background-color: #f44336;
        }
        .actions {
            margin-top: 10px;
        }
        .actions button {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>队列工作进程管理示例</h1>
        
        <div class="row">
            <div class="col">
                <div class="panel">
                    <div class="panel-header">启动新队列工作进程</div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="connection">连接</label>
                            <input type="text" id="connection" value="default" placeholder="输入连接名称">
                        </div>
                        <div class="form-group">
                            <label for="queue">队列</label>
                            <input type="text" id="queue" value="default" placeholder="输入队列名称">
                        </div>
                        <div class="form-group">
                            <label for="tries">尝试次数</label>
                            <input type="number" id="tries" value="3" min="1">
                        </div>
                        <div class="form-group">
                            <label for="timeout">超时时间（秒）</label>
                            <input type="number" id="timeout" value="60" min="1">
                        </div>
                        <div class="form-group">
                            <label for="sleep">休眠时间（秒）</label>
                            <input type="number" id="sleep" value="3" min="1">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="force">
                            <label for="force">强制启动</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="persistent" checked>
                            <label for="persistent">持久化</label>
                        </div>
                        <button id="start-worker">启动队列工作进程</button>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">全局操作</div>
                    <div class="panel-body">
                        <button id="stop-all-workers" class="danger">停止所有队列工作进程</button>
                        <button id="restart-all-workers" class="warning">重启所有队列工作进程</button>
                        <button id="cleanup-workers" class="info">清理已停止的队列工作进程</button>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="panel">
                    <div class="panel-header">
                        队列工作进程列表
                        <button class="info" style="float: right; padding: 2px 8px;" id="refresh-workers">刷新</button>
                    </div>
                    <div class="panel-body">
                        <div id="worker-list">
                            <div class="worker-item">
                                <p>暂无队列工作进程</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">队列工作进程输出</div>
                    <div class="panel-body">
                        <pre id="worker-output">选择一个队列工作进程查看输出</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 刷新队列工作进程列表
        function refreshWorkers() {
            fetch('/queue-worker-demo/all')
                .then(response => response.json())
                .then(data => {
                    const workerList = document.getElementById('worker-list');
                    
                    if (Object.keys(data.workers).length === 0) {
                        workerList.innerHTML = '<div class="worker-item"><p>暂无队列工作进程</p></div>';
                        return;
                    }
                    
                    let html = '';
                    for (const [alias, worker] of Object.entries(data.workers)) {
                        const status = worker.running ? 
                            '<span class="badge badge-success">运行中</span>' : 
                            '<span class="badge badge-danger">已停止</span>';
                        
                        html += `
                            <div class="worker-item">
                                <p><strong>别名:</strong> ${alias} ${status}</p>
                                <p><strong>连接:</strong> ${worker.connection}</p>
                                <p><strong>队列:</strong> ${worker.queue}</p>
                                <p><strong>PID:</strong> ${worker.pid || 'N/A'}</p>
                                <p><strong>尝试次数:</strong> ${worker.tries}</p>
                                <p><strong>超时时间:</strong> ${worker.timeout}秒</p>
                                <p><strong>休眠时间:</strong> ${worker.sleep}秒</p>
                                <p><strong>持久化:</strong> ${worker.persistent ? '是' : '否'}</p>
                                <div class="actions">
                                    <button class="info view-output" data-connection="${worker.connection}" data-queue="${worker.queue}">查看输出</button>
                                    <button class="danger stop-worker" data-connection="${worker.connection}" data-queue="${worker.queue}">停止</button>
                                    <button class="warning restart-worker" data-connection="${worker.connection}" data-queue="${worker.queue}">重启</button>
                                </div>
                            </div>
                        `;
                    }
                    
                    workerList.innerHTML = html;
                    
                    // 添加事件监听器
                    document.querySelectorAll('.view-output').forEach(button => {
                        button.addEventListener('click', function() {
                            const connection = this.getAttribute('data-connection');
                            const queue = this.getAttribute('data-queue');
                            viewWorkerOutput(connection, queue);
                        });
                    });
                    
                    document.querySelectorAll('.stop-worker').forEach(button => {
                        button.addEventListener('click', function() {
                            const connection = this.getAttribute('data-connection');
                            const queue = this.getAttribute('data-queue');
                            stopWorker(connection, queue);
                        });
                    });
                    
                    document.querySelectorAll('.restart-worker').forEach(button => {
                        button.addEventListener('click', function() {
                            const connection = this.getAttribute('data-connection');
                            const queue = this.getAttribute('data-queue');
                            restartWorker(connection, queue);
                        });
                    });
                })
                .catch(error => {
                    console.error('获取队列工作进程列表失败:', error);
                });
        }
        
        // 查看队列工作进程输出
        function viewWorkerOutput(connection, queue) {
            fetch(`/queue-worker-demo/output?connection=${connection}&queue=${queue}`)
                .then(response => response.json())
                .then(data => {
                    const outputElement = document.getElementById('worker-output');
                    let output = `=== ${connection}:${queue} 的输出 ===\n\n`;
                    
                    if (data.output) {
                        output += `标准输出:\n${data.output}\n\n`;
                    } else {
                        output += `标准输出: 无\n\n`;
                    }
                    
                    if (data.error) {
                        output += `错误输出:\n${data.error}`;
                    } else {
                        output += `错误输出: 无`;
                    }
                    
                    outputElement.textContent = output;
                })
                .catch(error => {
                    console.error('获取队列工作进程输出失败:', error);
                });
        }
        
        // 启动队列工作进程
        function startWorker() {
            const connection = document.getElementById('connection').value;
            const queue = document.getElementById('queue').value;
            const tries = document.getElementById('tries').value;
            const timeout = document.getElementById('timeout').value;
            const sleep = document.getElementById('sleep').value;
            const force = document.getElementById('force').checked;
            const persistent = document.getElementById('persistent').checked;
            
            if (!connection || !queue) {
                alert('连接和队列不能为空');
                return;
            }
            
            fetch('/queue-worker-demo/up', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    connection, 
                    queue, 
                    tries, 
                    timeout, 
                    sleep, 
                    force, 
                    persistent 
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshWorkers();
                    } else {
                        alert('启动队列工作进程失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('启动队列工作进程失败:', error);
                });
        }
        
        // 停止队列工作进程
        function stopWorker(connection, queue) {
            fetch('/queue-worker-demo/down', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ connection, queue }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshWorkers();
                    } else {
                        alert('停止队列工作进程失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('停止队列工作进程失败:', error);
                });
        }
        
        // 重启队列工作进程
        function restartWorker(connection, queue) {
            fetch('/queue-worker-demo/restart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ connection, queue }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshWorkers();
                    } else {
                        alert('重启队列工作进程失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('重启队列工作进程失败:', error);
                });
        }
        
        // 停止所有队列工作进程
        function stopAllWorkers() {
            fetch('/queue-worker-demo/down-all', {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        refreshWorkers();
                    } else {
                        alert('停止所有队列工作进程失败');
                    }
                })
                .catch(error => {
                    console.error('停止所有队列工作进程失败:', error);
                });
        }
        
        // 重启所有队列工作进程
        function restartAllWorkers() {
            fetch('/queue-worker-demo/restart-all', {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        refreshWorkers();
                    } else {
                        alert('重启所有队列工作进程失败');
                    }
                })
                .catch(error => {
                    console.error('重启所有队列工作进程失败:', error);
                });
        }
        
        // 清理已停止的队列工作进程
        function cleanupWorkers() {
            fetch('/queue-worker-demo/cleanup', {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        refreshWorkers();
                    } else {
                        alert('清理已停止的队列工作进程失败');
                    }
                })
                .catch(error => {
                    console.error('清理已停止的队列工作进程失败:', error);
                });
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 刷新队列工作进程列表
            refreshWorkers();
            
            // 添加事件监听器
            document.getElementById('start-worker').addEventListener('click', startWorker);
            document.getElementById('refresh-workers').addEventListener('click', refreshWorkers);
            document.getElementById('stop-all-workers').addEventListener('click', stopAllWorkers);
            document.getElementById('restart-all-workers').addEventListener('click', restartAllWorkers);
            document.getElementById('cleanup-workers').addEventListener('click', cleanupWorkers);
            
            // 定时刷新队列工作进程列表
            setInterval(refreshWorkers, 5000);
        });
    </script>
</body>
</html>
