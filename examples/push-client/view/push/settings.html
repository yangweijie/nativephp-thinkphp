<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>推送通知设置</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>推送通知客户端</h2>
            </div>
            
            <div class="nav-menu">
                <ul>
                    <li><a href="/push/index">主页</a></li>
                    <li><a href="/push/history">历史记录</a></li>
                    <li class="active"><a href="/push/settings">设置</a></li>
                </ul>
            </div>
        </div>
        
        <div class="main-content">
            <div class="content-header">
                <h1>推送通知设置</h1>
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
                </div>
            </div>
            
            <div class="settings-form">
                <div class="form-group">
                    <label for="providerSelect">推送服务提供商</label>
                    <select id="providerSelect" class="form-control">
                        <option value="firebase" {$provider == 'firebase' ? 'selected' : ''}>Firebase</option>
                        <option value="apns" {$provider == 'apns' ? 'selected' : ''}>APNS</option>
                        <option value="jpush" {$provider == 'jpush' ? 'selected' : ''}>极光推送</option>
                    </select>
                </div>
                
                <div id="firebaseSettings" class="provider-settings" style="display: {$provider == 'firebase' ? 'block' : 'none'}">
                    <h3>Firebase 设置</h3>
                    <div class="form-group">
                        <label for="firebaseServerKey">Server Key</label>
                        <input type="text" id="firebaseServerKey" class="form-control" value="{$config.firebase.server_key ?? ''}">
                    </div>
                    <div class="form-group">
                        <label for="firebaseSenderId">Sender ID</label>
                        <input type="text" id="firebaseSenderId" class="form-control" value="{$config.firebase.sender_id ?? ''}">
                    </div>
                </div>
                
                <div id="apnsSettings" class="provider-settings" style="display: {$provider == 'apns' ? 'block' : 'none'}">
                    <h3>APNS 设置</h3>
                    <div class="form-group">
                        <label for="apnsCertPath">证书路径</label>
                        <input type="text" id="apnsCertPath" class="form-control" value="{$config.apns.cert_path ?? ''}">
                    </div>
                    <div class="form-group">
                        <label for="apnsCertPassword">证书密码</label>
                        <input type="password" id="apnsCertPassword" class="form-control" value="{$config.apns.cert_password ?? ''}">
                    </div>
                    <div class="form-group">
                        <label for="apnsEnvironment">环境</label>
                        <select id="apnsEnvironment" class="form-control">
                            <option value="sandbox" {($config.apns.environment ?? '') == 'sandbox' ? 'selected' : ''}>Sandbox</option>
                            <option value="production" {($config.apns.environment ?? '') == 'production' ? 'selected' : ''}>Production</option>
                        </select>
                    </div>
                </div>
                
                <div id="jpushSettings" class="provider-settings" style="display: {$provider == 'jpush' ? 'block' : 'none'}">
                    <h3>极光推送设置</h3>
                    <div class="form-group">
                        <label for="jpushAppKey">App Key</label>
                        <input type="text" id="jpushAppKey" class="form-control" value="{$config.jpush.app_key ?? ''}">
                    </div>
                    <div class="form-group">
                        <label for="jpushMasterSecret">Master Secret</label>
                        <input type="password" id="jpushMasterSecret" class="form-control" value="{$config.jpush.master_secret ?? ''}">
                    </div>
                </div>
                
                <h3>通知设置</h3>
                <div class="form-group">
                    <label for="notificationSound">通知声音</label>
                    <select id="notificationSound" class="form-control">
                        <option value="default" {($config.notification.sound ?? '') == 'default' ? 'selected' : ''}>默认</option>
                        <option value="none" {($config.notification.sound ?? '') == 'none' ? 'selected' : ''}>无</option>
                        <option value="custom" {($config.notification.sound ?? '') == 'custom' ? 'selected' : ''}>自定义</option>
                    </select>
                </div>
                <div id="customSoundPath" class="form-group" style="display: {($config.notification.sound ?? '') == 'custom' ? 'block' : 'none'}">
                    <label for="notificationCustomSound">自定义声音路径</label>
                    <input type="text" id="notificationCustomSound" class="form-control" value="{$config.notification.custom_sound ?? ''}">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notificationBadge" {($config.notification.badge ?? true) ? 'checked' : ''}>
                        显示徽章
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notificationVibrate" {($config.notification.vibrate ?? true) ? 'checked' : ''}>
                        震动
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notificationLights" {($config.notification.lights ?? true) ? 'checked' : ''}>
                        指示灯
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // 切换推送服务提供商设置
        document.getElementById('providerSelect').addEventListener('change', function() {
            const provider = this.value;
            
            document.querySelectorAll('.provider-settings').forEach(function(element) {
                element.style.display = 'none';
            });
            
            document.getElementById(provider + 'Settings').style.display = 'block';
        });
        
        // 切换自定义声音设置
        document.getElementById('notificationSound').addEventListener('change', function() {
            const sound = this.value;
            
            if (sound === 'custom') {
                document.getElementById('customSoundPath').style.display = 'block';
            } else {
                document.getElementById('customSoundPath').style.display = 'none';
            }
        });
        
        // 保存设置
        function saveSettings() {
            const provider = document.getElementById('providerSelect').value;
            const config = {
                firebase: {
                    server_key: document.getElementById('firebaseServerKey').value,
                    sender_id: document.getElementById('firebaseSenderId').value,
                },
                apns: {
                    cert_path: document.getElementById('apnsCertPath').value,
                    cert_password: document.getElementById('apnsCertPassword').value,
                    environment: document.getElementById('apnsEnvironment').value,
                },
                jpush: {
                    app_key: document.getElementById('jpushAppKey').value,
                    master_secret: document.getElementById('jpushMasterSecret').value,
                },
                notification: {
                    sound: document.getElementById('notificationSound').value,
                    custom_sound: document.getElementById('notificationCustomSound').value,
                    badge: document.getElementById('notificationBadge').checked,
                    vibrate: document.getElementById('notificationVibrate').checked,
                    lights: document.getElementById('notificationLights').checked,
                },
            };
            
            fetch('/push/saveSettings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    provider,
                    config,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('保存设置失败');
            });
        }
    </script>
</body>
</html>
