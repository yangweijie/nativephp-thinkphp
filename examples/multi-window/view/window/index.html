<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>多窗口示例</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>多窗口示例</h1>
            <div class="window-info">
                <p><strong>当前窗口ID：</strong> <span id="currentWindowId">{$current.id}</span></p>
                <p><strong>当前窗口标题：</strong> <span id="currentWindowTitle">{$current.title}</span></p>
            </div>
        </div>
        
        <div class="content">
            <div class="card">
                <div class="card-header">
                    <h2>打开新窗口</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="windowUrl">窗口URL</label>
                        <input type="text" id="windowUrl" class="form-control" value="/window/child">
                    </div>
                    
                    <div class="form-group">
                        <label for="windowTitle">窗口标题</label>
                        <input type="text" id="windowTitle" class="form-control" value="子窗口">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-6">
                            <label for="windowWidth">宽度</label>
                            <input type="number" id="windowWidth" class="form-control" value="800">
                        </div>
                        
                        <div class="form-group col-6">
                            <label for="windowHeight">高度</label>
                            <input type="number" id="windowHeight" class="form-control" value="600">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-6">
                            <label for="windowX">X坐标</label>
                            <input type="number" id="windowX" class="form-control" placeholder="自动">
                        </div>
                        
                        <div class="form-group col-6">
                            <label for="windowY">Y坐标</label>
                            <input type="number" id="windowY" class="form-control" placeholder="自动">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="windowResizable" checked> 可调整大小
                            </label>
                            
                            <label>
                                <input type="checkbox" id="windowMinimizable" checked> 可最小化
                            </label>
                            
                            <label>
                                <input type="checkbox" id="windowMaximizable" checked> 可最大化
                            </label>
                            
                            <label>
                                <input type="checkbox" id="windowClosable" checked> 可关闭
                            </label>
                            
                            <label>
                                <input type="checkbox" id="windowAlwaysOnTop"> 总是置顶
                            </label>
                            
                            <label>
                                <input type="checkbox" id="windowFullscreen"> 全屏
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="openWindow()">打开窗口</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>窗口管理</h2>
                    <div class="card-actions">
                        <button class="btn btn-danger" onclick="closeAllWindows()">关闭所有窗口</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="window-list">
                        {if empty($windows)}
                        <p>暂无窗口</p>
                        {else}
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>标题</th>
                                    <th>URL</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {volist name="windows" id="window"}
                                <tr>
                                    <td>{$window.id}</td>
                                    <td>{$window.title}</td>
                                    <td>{$window.url}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="focusWindow('{$window.id}')">聚焦</button>
                                            <button class="btn btn-sm btn-secondary" onclick="minimizeWindow('{$window.id}')">最小化</button>
                                            <button class="btn btn-sm btn-secondary" onclick="maximizeWindow('{$window.id}')">最大化</button>
                                            <button class="btn btn-sm btn-secondary" onclick="restoreWindow('{$window.id}')">恢复</button>
                                            <button class="btn btn-sm btn-danger" onclick="closeWindow('{$window.id}')">关闭</button>
                                        </div>
                                    </td>
                                </tr>
                                {/volist}
                            </tbody>
                        </table>
                        {/if}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>窗口间通信</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="targetWindow">目标窗口</label>
                        <select id="targetWindow" class="form-control">
                            <option value="">选择目标窗口</option>
                            {volist name="windows" id="window"}
                            {if $window.id != $current.id}
                            <option value="{$window.id}">{$window.title} ({$window.id})</option>
                            {/if}
                            {/volist}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageContent">消息内容</label>
                        <textarea id="messageContent" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="sendMessage()">发送消息</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>接收到的消息</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="refreshMessages()">刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="messageList" class="message-list">
                        <p>暂无消息</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 定时检查消息
            setInterval(checkMessages, 2000);
            
            // 注册窗口关闭事件
            if (typeof window.NativePHP !== 'undefined') {
                window.NativePHP.window.onClose(function() {
                    console.log('窗口即将关闭');
                });
            }
        });
        
        // 打开窗口
        function openWindow() {
            const url = document.getElementById('windowUrl').value;
            const title = document.getElementById('windowTitle').value;
            const width = parseInt(document.getElementById('windowWidth').value);
            const height = parseInt(document.getElementById('windowHeight').value);
            const x = document.getElementById('windowX').value ? parseInt(document.getElementById('windowX').value) : null;
            const y = document.getElementById('windowY').value ? parseInt(document.getElementById('windowY').value) : null;
            const resizable = document.getElementById('windowResizable').checked;
            const minimizable = document.getElementById('windowMinimizable').checked;
            const maximizable = document.getElementById('windowMaximizable').checked;
            const closable = document.getElementById('windowClosable').checked;
            const alwaysOnTop = document.getElementById('windowAlwaysOnTop').checked;
            const fullscreen = document.getElementById('windowFullscreen').checked;
            
            fetch('/window/open', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url,
                    title,
                    width,
                    height,
                    x,
                    y,
                    resizable,
                    minimizable,
                    maximizable,
                    closable,
                    always_on_top: alwaysOnTop,
                    fullscreen,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    // 刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '打开窗口失败');
            });
        }
        
        // 关闭窗口
        function closeWindow(id) {
            if (!confirm('确定要关闭此窗口吗？')) {
                return;
            }
            
            fetch('/window/close', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    // 刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '关闭窗口失败');
            });
        }
        
        // 关闭所有窗口
        function closeAllWindows() {
            if (!confirm('确定要关闭所有窗口吗？')) {
                return;
            }
            
            fetch('/window/closeAll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '关闭所有窗口失败');
            });
        }
        
        // 最小化窗口
        function minimizeWindow(id) {
            fetch('/window/minimize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '最小化窗口失败');
            });
        }
        
        // 最大化窗口
        function maximizeWindow(id) {
            fetch('/window/maximize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '最大化窗口失败');
            });
        }
        
        // 恢复窗口
        function restoreWindow(id) {
            fetch('/window/restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '恢复窗口失败');
            });
        }
        
        // 聚焦窗口
        function focusWindow(id) {
            fetch('/window/focus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '聚焦窗口失败');
            });
        }
        
        // 发送消息
        function sendMessage() {
            const targetId = document.getElementById('targetWindow').value;
            const message = document.getElementById('messageContent').value;
            const sourceId = document.getElementById('currentWindowId').textContent;
            
            if (!targetId) {
                showNotification('错误', '请选择目标窗口');
                return;
            }
            
            if (!message) {
                showNotification('错误', '消息内容不能为空');
                return;
            }
            
            fetch('/window/sendMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    target_id: targetId,
                    message,
                    source_id: sourceId,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    // 清空消息内容
                    document.getElementById('messageContent').value = '';
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '发送消息失败');
            });
        }
        
        // 检查消息
        function checkMessages() {
            const windowId = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/getMessages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    window_id: windowId,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    // 显示消息
                    displayMessages(data.messages);
                    
                    // 显示通知
                    showNotification('新消息', `收到 ${data.messages.length} 条新消息`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // 刷新消息
        function refreshMessages() {
            checkMessages();
        }
        
        // 显示消息
        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            
            // 清空消息列表
            if (messageList.innerHTML.includes('暂无消息')) {
                messageList.innerHTML = '';
            }
            
            // 添加新消息
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message-item';
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-source">来自窗口: ${message.source_id}</span>
                        <span class="message-time">${message.created_at}</span>
                    </div>
                    <div class="message-content">${message.message}</div>
                `;
                messageList.appendChild(messageElement);
            });
        }
        
        // 显示通知
        function showNotification(title, body) {
            if (typeof window.NativePHP !== 'undefined') {
                window.NativePHP.notification.send(title, body);
            } else {
                alert(`${title}: ${body}`);
            }
        }
    </script>
</body>
</html>
