<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{$windowInfo.title ?? '子窗口'}</title>
    <link rel="stylesheet" href="/static/css/app.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{$windowInfo.title ?? '子窗口'}</h1>
            <div class="window-info">
                <p><strong>当前窗口ID：</strong> <span id="currentWindowId">{$current.id}</span></p>
                <p><strong>当前窗口标题：</strong> <span id="currentWindowTitle">{$current.title}</span></p>
            </div>
        </div>
        
        <div class="content">
            <div class="card">
                <div class="card-header">
                    <h2>窗口属性</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="windowTitle">窗口标题</label>
                        <div class="input-group">
                            <input type="text" id="windowTitle" class="form-control" value="{$current.title}">
                            <button class="btn btn-primary" onclick="setTitle()">设置</button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-6">
                            <label for="windowWidth">宽度</label>
                            <input type="number" id="windowWidth" class="form-control" value="{$current.width}">
                        </div>
                        
                        <div class="form-group col-6">
                            <label for="windowHeight">高度</label>
                            <input type="number" id="windowHeight" class="form-control" value="{$current.height}">
                        </div>
                        
                        <div class="form-group col-12">
                            <button class="btn btn-primary" onclick="setSize()">设置大小</button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-6">
                            <label for="windowX">X坐标</label>
                            <input type="number" id="windowX" class="form-control" value="{$current.x}">
                        </div>
                        
                        <div class="form-group col-6">
                            <label for="windowY">Y坐标</label>
                            <input type="number" id="windowY" class="form-control" value="{$current.y}">
                        </div>
                        
                        <div class="form-group col-12">
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" id="positionAnimated"> 使用动画
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="setPosition()">设置位置</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="windowAlwaysOnTop" {$windowInfo.options.alwaysOnTop ? 'checked' : ''}> 总是置顶
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="setAlwaysOnTop()">设置</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>窗口操作</h2>
                </div>
                <div class="card-body">
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="minimizeWindow()">最小化</button>
                        <button class="btn btn-primary" onclick="maximizeWindow()">最大化</button>
                        <button class="btn btn-primary" onclick="restoreWindow()">恢复</button>
                        <button class="btn btn-danger" onclick="closeWindow()">关闭</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>窗口间通信</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="targetWindow">目标窗口</label>
                        <select id="targetWindow" class="form-control">
                            <option value="">选择目标窗口</option>
                            {volist name="windows" id="window"}
                            {if $window.id != $current.id}
                            <option value="{$window.id}">{$window.title} ({$window.id})</option>
                            {/if}
                            {/volist}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageContent">消息内容</label>
                        <textarea id="messageContent" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="sendMessage()">发送消息</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>接收到的消息</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="refreshMessages()">刷新</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="messageList" class="message-list">
                        <p>暂无消息</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/app.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 定时检查消息
            setInterval(checkMessages, 2000);
            
            // 注册窗口事件
            if (typeof window.NativePHP !== 'undefined') {
                // 窗口关闭事件
                window.NativePHP.window.onClose(function() {
                    console.log('窗口即将关闭');
                });
                
                // 窗口聚焦事件
                window.NativePHP.window.onFocus(function() {
                    console.log('窗口获得焦点');
                });
                
                // 窗口失去焦点事件
                window.NativePHP.window.onBlur(function() {
                    console.log('窗口失去焦点');
                });
                
                // 窗口移动事件
                window.NativePHP.window.onMove(function(event) {
                    console.log('窗口移动', event);
                    document.getElementById('windowX').value = event.x;
                    document.getElementById('windowY').value = event.y;
                });
                
                // 窗口调整大小事件
                window.NativePHP.window.onResize(function(event) {
                    console.log('窗口调整大小', event);
                    document.getElementById('windowWidth').value = event.width;
                    document.getElementById('windowHeight').value = event.height;
                });
            }
        });
        
        // 设置窗口标题
        function setTitle() {
            const title = document.getElementById('windowTitle').value;
            const id = document.getElementById('currentWindowId').textContent;
            
            if (!title) {
                showNotification('错误', '窗口标题不能为空');
                return;
            }
            
            fetch('/window/setTitle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                    title,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    document.getElementById('currentWindowTitle').textContent = title;
                    document.title = title;
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '设置窗口标题失败');
            });
        }
        
        // 设置窗口大小
        function setSize() {
            const width = parseInt(document.getElementById('windowWidth').value);
            const height = parseInt(document.getElementById('windowHeight').value);
            const id = document.getElementById('currentWindowId').textContent;
            
            if (!width || !height) {
                showNotification('错误', '窗口宽度和高度不能为空');
                return;
            }
            
            fetch('/window/setSize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                    width,
                    height,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '设置窗口大小失败');
            });
        }
        
        // 设置窗口位置
        function setPosition() {
            const x = parseInt(document.getElementById('windowX').value);
            const y = parseInt(document.getElementById('windowY').value);
            const animated = document.getElementById('positionAnimated').checked;
            const id = document.getElementById('currentWindowId').textContent;
            
            if (isNaN(x) || isNaN(y)) {
                showNotification('错误', '窗口位置不能为空');
                return;
            }
            
            fetch('/window/setPosition', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                    x,
                    y,
                    animated,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '设置窗口位置失败');
            });
        }
        
        // 设置窗口是否总是置顶
        function setAlwaysOnTop() {
            const alwaysOnTop = document.getElementById('windowAlwaysOnTop').checked;
            const id = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/alwaysOnTop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                    always_on_top: alwaysOnTop,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '设置窗口置顶状态失败');
            });
        }
        
        // 最小化窗口
        function minimizeWindow() {
            const id = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/minimize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '最小化窗口失败');
            });
        }
        
        // 最大化窗口
        function maximizeWindow() {
            const id = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/maximize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '最大化窗口失败');
            });
        }
        
        // 恢复窗口
        function restoreWindow() {
            const id = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/restore', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '恢复窗口失败');
            });
        }
        
        // 关闭窗口
        function closeWindow() {
            const id = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/close', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(data.message);
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '关闭窗口失败');
            });
        }
        
        // 发送消息
        function sendMessage() {
            const targetId = document.getElementById('targetWindow').value;
            const message = document.getElementById('messageContent').value;
            const sourceId = document.getElementById('currentWindowId').textContent;
            
            if (!targetId) {
                showNotification('错误', '请选择目标窗口');
                return;
            }
            
            if (!message) {
                showNotification('错误', '消息内容不能为空');
                return;
            }
            
            fetch('/window/sendMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    target_id: targetId,
                    message,
                    source_id: sourceId,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('成功', data.message);
                    // 清空消息内容
                    document.getElementById('messageContent').value = '';
                } else {
                    showNotification('错误', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('错误', '发送消息失败');
            });
        }
        
        // 检查消息
        function checkMessages() {
            const windowId = document.getElementById('currentWindowId').textContent;
            
            fetch('/window/getMessages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    window_id: windowId,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    // 显示消息
                    displayMessages(data.messages);
                    
                    // 显示通知
                    showNotification('新消息', `收到 ${data.messages.length} 条新消息`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // 刷新消息
        function refreshMessages() {
            checkMessages();
        }
        
        // 显示消息
        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            
            // 清空消息列表
            if (messageList.innerHTML.includes('暂无消息')) {
                messageList.innerHTML = '';
            }
            
            // 添加新消息
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message-item';
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="message-source">来自窗口: ${message.source_id}</span>
                        <span class="message-time">${message.created_at}</span>
                    </div>
                    <div class="message-content">${message.message}</div>
                `;
                messageList.appendChild(messageElement);
            });
        }
        
        // 显示通知
        function showNotification(title, body) {
            if (typeof window.NativePHP !== 'undefined') {
                window.NativePHP.notification.send(title, body);
            } else {
                alert(`${title}: ${body}`);
            }
        }
    </script>
</body>
</html>
